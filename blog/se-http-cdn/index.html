<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>掌握 HTTP 缓存——从请求到响应过程的一切 | 笑笑前端圈</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="HTTP,CDN" />
    
    <meta name="description" content="CDN类的网站曾经一度雄踞 Alexa 域名排行的前 100。以前一些小网站不需要使用 CDN 或者根本负担不起其价格，不过这一现象近几年发生了很大的变化，CDN 市场上出现了很多按次付费，非公司性的提供商，这使得 CDN 变成人人都能负担的起的一种服务了。本文讲述的就是如何使用这种简单易用的缓存服务。
使用内容分发网络（ CDN ）你需要先正确地认识 HTTP 响应头：和 HTTP 响应头中的哪">
<meta property="og:type" content="article">
<meta property="og:title" content="掌握 HTTP 缓存——从请求到响应过程的一切">
<meta property="og:url" content="http://xiaoxiaoqdq.com/blog/se-http-cdn/index.html">
<meta property="og:site_name" content="笑笑前端圈">
<meta property="og:description" content="CDN类的网站曾经一度雄踞 Alexa 域名排行的前 100。以前一些小网站不需要使用 CDN 或者根本负担不起其价格，不过这一现象近几年发生了很大的变化，CDN 市场上出现了很多按次付费，非公司性的提供商，这使得 CDN 变成人人都能负担的起的一种服务了。本文讲述的就是如何使用这种简单易用的缓存服务。
使用内容分发网络（ CDN ）你需要先正确地认识 HTTP 响应头：和 HTTP 响应头中的哪">
<meta property="og:image" content="https://huzidaha.github.io/images-store/201702/9-1.png">
<meta property="og:updated_time" content="2017-03-12T05:52:01.334Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="掌握 HTTP 缓存——从请求到响应过程的一切">
<meta name="twitter:description" content="CDN类的网站曾经一度雄踞 Alexa 域名排行的前 100。以前一些小网站不需要使用 CDN 或者根本负担不起其价格，不过这一现象近几年发生了很大的变化，CDN 市场上出现了很多按次付费，非公司性的提供商，这使得 CDN 变成人人都能负担的起的一种服务了。本文讲述的就是如何使用这种简单易用的缓存服务。
使用内容分发网络（ CDN ）你需要先正确地认识 HTTP 响应头：和 HTTP 响应头中的哪">
<meta name="twitter:image" content="https://huzidaha.github.io/images-store/201702/9-1.png">
    

    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端笔记/">前端笔记</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端笔记/CSS/">CSS</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端笔记/Javascript/">Javascript</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端笔记/Service/">Service</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/面试宝典/">面试宝典</a></li></ul>
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">关于</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/前端笔记/">前端笔记</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/categories/前端笔记/Service/">Service</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-se-http-cdn" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        掌握 HTTP 缓存——从请求到响应过程的一切
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                
	<i class="icon fa fa-user"></i>
    <span class="article-author">Ulrich Kautz</span>

                <i class="icon fa fa-clock-o"></i>
<a href="/blog/se-http-cdn/" class="article-date">
    <time datetime="2017-03-11T15:32:00.000Z" itemprop="datePublished">2017-03-11</time>
</a>
                <i class="icon fa fa-eye"></i>
<span id="/blog/se-http-cdn/" class="leancloud-views_num" data-flag-title="掌握 HTTP 缓存——从请求到响应过程的一切"></span>

                
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CDN/">CDN</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTTP/">HTTP</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p><strong>CDN类的网站曾经一度雄踞 Alexa 域名排行的前 100。以前一些小网站不需要使用 CDN 或者根本负担不起其价格，不过这一现象近几年发生了很大的变化，CDN 市场上出现了很多按次付费，非公司性的提供商，这使得 CDN 变成人人都能负担的起的一种服务了。本文讲述的就是如何使用这种简单易用的缓存服务。</strong></p>
<p>使用内容分发网络（ CDN ）你需要先正确地认识 HTTP 响应头：和 HTTP 响应头中的哪些标签相关？它们是怎么起作用的？如何使用它们？文章中我会回答这些问题。</p>
<p>本文讲的并不会像教科书那么精确，实际上在某些情况下，为了叙述的清晰、简洁，我会按自己的理解简化某些问题，文章中会通过一些实际的例子来介绍缓存理论。在这篇文章的基础上，还会写一些文章来介绍对于某些指定的 CMS 或框架如何使用 CDN 来作为缓存层。</p>
<h2 id="为什么使用-CDN？"><a href="#为什么使用-CDN？" class="headerlink" title="为什么使用 CDN？"></a>为什么使用 CDN？</h2><p>CDN 是一个全球分布式网络，它把网站内容更快地传递给全球范围内的一个具体位置，而往往这个具体的位置离实际的内容服务器距离很远。举个例子，你的网站主机在爱尔兰，而你的用户则在澳大利亚访问。这时当你的用户访问你的网站的时候，延迟会很大，把你的（静态）数据用 CDN 放到澳大利亚则会很大程度上提高用户访问网站的体验。</p>
<p>然而 CDN 的使用并不局限于此。其实 CDN 可以理解成一个普通缓存，如<strong>代理缓存</strong>（边缘缓存）。即便你并不关心用户的具体地理位置，你也应该考虑使用 CDN 的代理缓存来提高你的用户体验。</p>
<h2 id="为什么使用代理缓存？"><a href="#为什么使用代理缓存？" class="headerlink" title="为什么使用代理缓存？"></a>为什么使用代理缓存？</h2><p>简而言之，代理缓存会缓存你网站一些页面，通过缓存来传输“静态”内容非常快。一个简单的例子，假设你有一个带有开始页面的博客，这里面列出了所有近期的博客列表。完成这一过程，PHP 脚本要从数据库中获取到最近的文章实体，并且将它们转换成 HTML 结果页并返回给用户。因此，对于一次请求（访问）包含了：一次 PHP 执行 + 一组数据库查询。对于 1000 次请求（访问）包含了：1000 次 PHP 执行 + 1000 组数据库查询。每一次 PHP 执行都要进行 CPU、内存和 I/O 操作，对于数据库操作也是同样。</p>
<p>请求的需求量和访问用户的多少呈线性正比关系。听起来怎么样？不怎么样，因为这个线性关系是有最大限度的：磁盘最大只能提供一定程度的 I/O，CPU 和内存也都不是无限的。这样下去到了某个点，也就是说某个资源到了瓶颈的时候，就出现问题了：你的网站会访问的非常慢，甚至会出现所有人都不能访问的情况。其实这时其他资源并没有被全部打满。诚然，这时你可以扩展你的硬件规模来突破这一瓶颈，但是这将使工程变得很复杂，成本也更高。实际上还有更简单、更便宜的解决方法。</p>
<p>在中间加一层代理缓存，会减少资源对你的限制。拿前面的例子来讲，使用代理缓存只有第一次请求需要执行 PHP 脚本、查询数据库和生成 HTML 结果页。所有后面过来的请求都会从这个缓存中取内容，读取缓存几乎和直接读取内存一样快。这意味着，上面的线性规模瓶颈的问题解决了！100 个用户或者1000 个用户都没关系，依然只有 1 次 PHP 执行、1 次数据库查询和 1 次的结果页生成。</p>
<h2 id="CDN-CDN"><a href="#CDN-CDN" class="headerlink" title="CDN != CDN"></a>CDN != CDN</h2><p>CDN 的类型也各有不同。网站管理者可能会好奇数据是怎么存储的？存放在哪？以及数据是如何分布在 CDN 上的？是如何分发的呢？本文不是写给网站管理者的而是写给开发者的，所以在这我只能告诉你有“经典 CDN”和“对等 CDN”，后者是现在主流采用的方法。</p>
<p>对于开发者，相比于把数据拿到 CDN 以后做什么来说，会对如何把数据放到 CDN 中更感兴趣。说起来，有 <strong>push CDN</strong> 和 <strong>pull CDN</strong> 两种。顾名思义，“push CDN” 表示你要给 CDN 提供内容；“pull CDN” 表示如何从 CDN 取内容。</p>
<p>本文将主要介绍 pull CDN，因为在很多情况下 pull CDN 更加简单易用，不需要费多大事就能集成到现有的网站中。</p>
<h2 id="pull-CDN-是如何起作用的？"><a href="#pull-CDN-是如何起作用的？" class="headerlink" title="pull CDN 是如何起作用的？"></a>pull CDN 是如何起作用的？</h2><p>我们来做个例子，假设你有一个可访问的网站，URL 是 <a href="https://www.foobar.tld。在这样的场景下，域名" target="_blank" rel="external">https://www.foobar.tld。在这样的场景下，域名</a> www.foobar.tld 会被放到 pull CDN 服务器中，而不是你的网站服务器中。CDN 作为你网站服务器的一个<strong>代理</strong>。</p>
<p>还有一个不被公开的域名指向实际的网站服务器。在这个例子中假设它是 direct.foobar.tld，实际网站服务器叫做<strong>源</strong>。</p>
<p>这个 CDN 将会接受所有的请求。如果它的缓存中有结果的话将会直接返回给用户，否则会将这个请求托管给你实际的网站服务器，然后把返回的结果缓存起来为以后的请求做储备，同时将结果返回给用户。</p>
<p><img src="https://huzidaha.github.io/images-store/201702/9-1.png" alt=""></p>
<p>最简单的 pull CDN 运行的过程如下：</p>
<ul>
<li>获取一个页面的请求，这个页面：<a href="http://www.foobar.tld/some/page" target="_blank" rel="external">http://www.foobar.tld/some/page</a></li>
<li>把 some/page 当做缓存 key 检查缓存中是否存在</li>
<li>在缓存中则直接从缓存中返回结果给用户</li>
<li>不在缓存则请求 <a href="http://direct.foobar.tld/some/page，把返回的结果以" target="_blank" rel="external">http://direct.foobar.tld/some/page，把返回的结果以</a> some/page 作为 key 写入缓存，并返回结果给用户</li>
</ul>
<h2 id="静态内容-VS-动态内容"><a href="#静态内容-VS-动态内容" class="headerlink" title="静态内容 VS 动态内容"></a>静态内容 VS 动态内容</h2><p>上面的这一过程对于完全静态的内容完全适用。静态内容指的是如果用户访问同一个 URL 地址，返回的所有数据都是一样的。比如 CSS 文件就有这样的特点，<a href="http://www.foobar.tld/public/css/main.css" target="_blank" rel="external">http://www.foobar.tld/public/css/main.css</a> 这个文件是一个普通文件，对于所有访问网站的用户都是一样的，那么它就特别适合用缓存存起来。</p>
<p>和静态文件相对的是动态文件。内容在运行时才能确定，这种情况也是非常常见的。比如多语言问题，需要根据浏览器语言来返回内容。还有一些和 “user session” 相关的内容，比如当用户登陆了以后，就要把“登陆”按钮换成“退出”按钮，你肯定不希望这个被缓存。这些高度活跃的内容（如每小时或者更短时间更新的页面）不能被缓存，或者说不能在缓存中停留时间过长。</p>
<p>这就是缓存有意思的地方，理解和实现它并不难。</p>
<h2 id="缓存头"><a href="#缓存头" class="headerlink" title="缓存头"></a>缓存头</h2><p>绝大多数的 pull CDN 采用以“每页”缓存形式解决动态内容的问题。为了达到这样的效果，一个简单的方法是 HTPP 响应缓存头。</p>
<p>首先对于缓存头你需要知道有“旧版本”和“新版本”两种，就是说它并不是一开始就设计成当前所使用的这个版本的，也有一个逐渐演变的过程。新版本指的是 HTTP/1.1，而旧版本指的是 HTTP/1.0。它有特别多的可选选项，每个人对这个问题都很头疼。我认为这是大家不愿意使用缓存头的最重要的原因。</p>
<p>言归正传，我们只关注 <code>ETag</code> 和 <code>Cache-Control</code> 这两个标签就足以了。大多数 CDN 还支持旧版本（<code>Expires</code>，<code>Pragma</code> 和 <code>Age</code>），不过这些只作为向后兼容来使用。</p>
<h3 id="ETag-头"><a href="#ETag-头" class="headerlink" title="ETag 头"></a>ETag 头</h3><p>我们从最简单的开始 <code>ETag</code>：它是文档版本的标识符。通常是内容的 MD5 值，不过它也可以包含其他内容，代表的是文档的版本/日期，如： 1.0 或者 2017-02-27。这里注意一点是，它必须用双引号括起来，如：<code>ETag: &quot;d3b07384d113edec49eaa6238ad5ff00&quot;</code>。</p>
<h4 id="二次验证"><a href="#二次验证" class="headerlink" title="二次验证"></a>二次验证</h4><p>现在来考虑 <code>ETag</code> 的实际应用：二次验证。我们暂时不考虑前面代理+源的架构模式，只考虑简单的客户端-服务器模式。如下图：</p>
<p><img src="https://huzidaha.github.io/images-store/201702/9-2.png" alt=""></p>
<p>假设客户端请求了 <a href="http://www.foobar.tld/hello.txt，接着服务端返回了如下的响应内容：" target="_blank" rel="external">http://www.foobar.tld/hello.txt，接着服务端返回了如下的响应内容：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">	# REQUEST</div><div class="line">	GET /hello.txt HTTP/1.1</div><div class="line">	Host: www.foobar.tld</div><div class="line">	</div><div class="line">	# RESPONSE</div><div class="line">	HTTP/1.1 200 OK</div><div class="line">	Date: Sun, 05 Feb 2017 12:34:56 UTC</div><div class="line">	Server: Apache</div><div class="line">	Last-Modified: Sun, 05 Feb 2017 10:34:56 UTC</div><div class="line">	ETag: &quot;8a75d48aaf3e72648a4e3747b713d730&quot;</div><div class="line">	Content-Length: 8</div><div class="line">	Content-Type: text/plain; charset=UTF-8</div><div class="line">```	</div><div class="line">`the body`在响应里面，有两个有意思的头标识：一个是 `ETag`，内容的 MD5值，一个是 `Last-Modified`，这是 `hello.txt` 文件最后一次被修改的时间。</div><div class="line"></div><div class="line">这里就是二次验证起作用的地方：当客户端在很短的时间内再次访问上面的 URL，客户端浏览器会使用 `If-*` 请求头。如 `If-None-Match` 检查 `ETag` 的内容是否有改变。也就是说，如果 `ETag` 发生变化，客户端接收到的一个完整的新响应；如果 `ETag` 没变化，客户端接收到的是一个表明内容没变化的标识。</div></pre></td></tr></table></figure></p>
<pre><code>GET /hello.txt HTTP/1.1
If-None-Match: &quot;8a75d48aaf3e72648a4e3747b713d730&quot;
Host: www.foobar.tld
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">如果 `ETag` 没有改变，那么服务端将会返回：</div><div class="line">```	</div><div class="line">	HTTP/1.1 304 Not Modified</div><div class="line">	Date: Sun, 05 Feb 2017 12:34:57 UTC</div><div class="line">	Server: Apache</div><div class="line">	Last-Modified: Sun, 05 Feb 2017 10:34:56 UTC</div><div class="line">	ETag: &quot;8a75d48aaf3e72648a4e3747b713d730&quot;</div><div class="line">	Content-Length: 8</div><div class="line">	Content-Type: text/plain; charset=UTF-8</div></pre></td></tr></table></figure>
<p>正如上面所展示的，这次服务器的响应里面不是 <em>200 ok</em>，而是<em>304 Not Modified</em>，这就是说它略过包体部分，让客户端直接去自己的缓存里拿数据。在这个例子中，包体内容是 <em>the body</em>，比较小，效果不明显。可是想象一下如果是很大的内容呢，或者是很复杂的动态生成内容呢，价值就很大了。</p>
<p>作为一个开发者，你可能会想：“<em>并没有那么好用嘛，我还不得不掌握 IF- 类的头标识，比以前更费事了</em>”。</p>
<p>别急，这只是介绍了共享缓存，也就是代理缓存的由来，我们看原始的架构：&lt;客户端-代理-源端&gt;，代理根据自己的缓存返回给客户端 <em>304 Not Modified</em>，接下来的章节详解介绍，介绍之前我要先讲一下 <code>Last-Modfied</code> 头。</p>
<p>在处理上面那个 <code>hello.txt</code> 静态文件的例子时，客户端还可以使用 <code>If-Not-Modified-Since: Sun, 05 Feb 2017 10:34:56 UTC</code> 来达到同样的效果（返回 304 响应）。这对于静态文件来说也很好用，因为响应头中的 <code>Last-Modified</code> 标识是根据服务器磁盘上的“更改时间戳”自动生成的。然而，“更改时间戳”对于动态文件通常没什么用，因为动态生成文件频繁更新，时间戳很难确定。我们都知道，你最想缓存起来的是内容，生成内容的代价是最大的，所以 <code>ETag</code> 头是更好的选择。</p>
<h3 id="Cache-Control头"><a href="#Cache-Control头" class="headerlink" title="Cache-Control头"></a><code>Cache-Control</code>头</h3><p><code>Cache-Control</code> 头相对来讲难一些。两个原因：第一，<code>Cache-Control</code> 既可以用于请求头，也可以用于响应头。本文中着重讨论响应头，因为这是开发者所必须要掌握的。第二，它控制着<strong>两个缓存</strong>：本地缓存（又称私有缓存）和共享缓存。</p>
<p><strong>本地缓存</strong>，是指在客户端本地机器中的缓存。站在开发者的角度，它并不完全受你的控制，通常浏览器会自己决定是否把某些内容放到缓存中，这意味着：不要依赖于本地缓存。用户也可能在关闭浏览器的时候清理所有缓存，而你并不知道有这样的操作。除非你监测到了某个用户的流量不断上涨，导致缓存内容迅速失效，这时候你才会意识到。</p>
<p><strong>共享缓存</strong>，也就是本文所介绍的：处于客户端和服务器之间的缓存。即 CDN。你对共享缓存拥有绝对的控制，应该好好地利用它。</p>
<p>现在我们来用一些代码作为示例深入学习一下。</p>
<ol>
<li><code>Cache-Control: public max-age=3600</code></li>
<li><code>Cache-Control: private immutable</code></li>
<li><code>Cache-Control: no-cache</code></li>
<li><code>Cache-Control: public max-age=3600 s-maxage=7200</code></li>
<li><code>Cache-Control: public max-age=3600 proxy-revalidate</code></li>
</ol>
<p>乍一看这些代码很令人困惑，但是不要担心，它并没有那么难，我来一点点介绍。首先你要知道 <code>Cache-Control</code> 有三种属性：缓冲能力、过期时间和二次验证。</p>
<p>首先是<strong>缓冲能力</strong>，它关注的是缓存到什么地方，和是否应该被缓存。他的几个重要的属性是：</p>
<ul>
<li><code>private</code>：表示它只应该存在本地缓存；</li>
<li><code>public</code>：表示它既可以存在共享缓存，也可以被存在本地缓存；</li>
<li><code>no-cache</code>：表示不论是本地缓存还是共享缓存，在使用它以前必须用缓存里的值来重新验证；</li>
<li><code>no-store</code>：表示不允许被缓存。</li>
</ul>
<p>第二个是<strong>过期时间</strong>，很显然它关注的是内容可以被缓存多久。它的几个重要的属性是：</p>
<ul>
<li><code>max-age=&lt;seconds&gt;</code>：设置缓存时间，设置单位为秒。本地缓存和共享缓存都可以；</li>
<li><code>s-maxage=&lt;seconds&gt;</code>：覆盖 <code>max-age</code> 属性。只在共享缓存中起作用。</li>
</ul>
<p>最后一个是<strong>二次验证</strong>，表示精细控制。它的几个重要属性是：</p>
<ul>
<li><code>immutable</code>：表示文档是不能更改的。</li>
<li><code>must-revalidate</code>：表示客户端（浏览器）必须检查代理服务器上是否存在，即使它已经本地缓存了也要检查。</li>
<li><code>proxy-revalidata</code>：表示共享缓存（CDN）必须要检查源是否存在，即使已经有缓存。</li>
</ul>
<p>通过上面的具体解释，现在再来描述上面 <code>Cache-Control</code> 的那段代码所表达的意思就好理解多了：</p>
<ol>
<li>本地缓存和 CDN 缓存均缓存 1 小时；</li>
<li>不能缓存在 CDN，只能缓存在本地。并且一旦被缓存了，则不能被更新；</li>
<li>不能缓存。如果一定要缓存的话，确保对其进行了二次验证；</li>
<li>本地缓存 1 小时，CDN 上缓存 2 小时；</li>
<li>本地和 CDN 均缓存 1 小时。但是如果 CDN 收到请求，则尽管已经缓存了 1 小时，还是要检查源中文档是否已经被改变。</li>
</ol>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p>理论会很单调乏味，现在用短的实例来演示如何自动注入 <code>ETag</code> 和 <code>Cache-Control</code> 头。例子是一个 Apache 的 <code>.htaccess</code> 文件，但是我希望你能够领会要领，并且根据你自己的实际情况，应用到你自己的 Web 应用中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># 为所有图片设置 ETag，以及缓存时间为 1 天</div><div class="line">&lt;FilesMatch &quot;\.(gif|flv|jpg|jpeg|png|gif|swf)$&quot;&gt;</div><div class="line">    FileETag -INode MTime Size</div><div class="line">    Header set Cache-Control &quot;max-age=86400 public&quot;</div><div class="line">&lt;/FilesMatch&gt;</div><div class="line"></div><div class="line"># 为所有的 CSS 文件、JS 文件设置 ETag，以及缓存时间为 2 小时，同时保证进行了二次验证</div><div class="line">&lt;FilesMatch &quot;\.(js|css)$&quot;&gt;</div><div class="line">    FileETag -INode MTime Size</div><div class="line">    Header set Cache-Control &quot;max-age=7200 public must-revalidate&quot;</div><div class="line">    Header unset Last-Modified</div><div class="line">&lt;/FilesMatch&gt;</div></pre></td></tr></table></figure></p>
<p>上面例子，是一个对 URL：<a href="http://www.foobar.tld/baz.jpg" target="_blank" rel="external">http://www.foobar.tld/baz.jpg</a> 的响应。包含了一个 <code>ETag</code> 头，由更改时间和文件大小所构成，还有 <code>Cache-Control</code> 头来设定缓存 1 天的时间。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># REQUEST</div><div class="line">GET /baz.jpg HTTP/1.1</div><div class="line">Host: www.foobar.tld</div><div class="line"></div><div class="line"># RESPONSE</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Date: Tue, 07 Feb 2017 15:01:20 GMT</div><div class="line">Last-Modified: Tue, 07 Feb 2017 15:01:15 GMT</div><div class="line">ETag: &quot;4-547f20501b9e9&quot;</div><div class="line">Content-Length: 123</div><div class="line">Cache-Control: max-age=86400 public</div><div class="line">Content-Type: image/jpeg</div></pre></td></tr></table></figure></p>
<p>对于 URL： <a href="http://www.foobar.tld/dist/css/styles.css" target="_blank" rel="external">http://www.foobar.tld/dist/css/styles.css</a> 的响应同样也包含了 <code>ETag</code> 头。由更改时间、文件大小和限定了 2 小时的 <code>Cache-Control</code> 构成。<code>Last-Modfied</code> 头也删除掉以确保只有 <code>ETag</code> 用来做二次验证。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># REQUEST</div><div class="line">GET /styles.css HTTP/1.1</div><div class="line">Host: www.foobar.tld</div><div class="line"></div><div class="line"># RESPONSE</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Date: Tue, 07 Feb 2017 15:00:00 GMT</div><div class="line">Server: Apache</div><div class="line">ETag: &quot;20-547f1fbe02409&quot;</div><div class="line">Content-Length: 32</div><div class="line">Cache-Control: max-age=7200 public must-revalidate</div><div class="line">Content-Type: text/css</div></pre></td></tr></table></figure></p>
<h2 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h2><p>你已经知道了缓存头是如何起作用的，现在我们来看下在缓存里面 cookie 起了什么作用。首先， Cookie 的设定也在 HTTP 响应头中，名字是 <code>Set-Cookie</code>。设置一个 cookie 的目的是标识这个用户，就是说你需要为每个用户设置一个 cookie。</p>
<p>想象一下缓存的场景，你是否会缓存一个包含了 <code>Set-Cookie</code>的 HTTP 响应，在缓存时间内，每个人都会得到相同的 cookie 和同样的用户 session？你肯定不想这样。</p>
<p>另外，用户 session 状态的改变可能会影响到响应内容的变化。一个简单的场景：电商购物车。你给用户要么提供一个空购物车，要么是用户自己选了很多物品的购物车。同样的道理，你不希望这个也被缓存，毕竟每个用户都应该有自己的购物车。</p>
<p>一个解决方法是在运行时通过 JavaScript 设置 Cookie，比如 Google Analytics。GA 通过 JS 设置 cookie，但这个 cookie 既不影响渲染，也不设置 <code>Set-Cookie</code> 头。GA 会在目标网站上添加类似于 “you are tracked via Google Analytics” 的图标，<em>但是只要这些改变都是在运行时添加进去的，就都没有问题</em>。</p>
<h2 id="正确处理-cookie-和缓存"><a href="#正确处理-cookie-和缓存" class="headerlink" title="正确处理 cookie 和缓存"></a>正确处理 cookie 和缓存</h2><p>首先你需要知道你网站的 cookie 的工作原理。cookie 是不是只在特定时间使用（如在用户登录过程中使用）？原则上，cookie 是不是会被注入到所有响应？</p>
<p>正如上一节所说的，不论何时服务器返回了一个带有 <code>Set-Cookie</code> 的响应，你都希望能够保证它不会被缓存。那么问题就转化成为，当你返回一个带有“用户特性”内容的响应时（如购物车），CDN /代理服务器，会作何操作？</p>
<ul>
<li>如果没设置 <code>Set-Cookie</code>，是不是允许缓存呢？</li>
<li>如果设置了 <code>Set-Cookie</code>，是不是自动丢弃所有 <code>Cache-Control</code> 头呢？</li>
</ul>
<p>其实，如果从应用层面来讲，你尽管可以去实现你所喜欢的 web 应用就可以了，至于 cookie 和 CDN 都是自动设置的。还是用 Apache 的 <code>.htaccess</code> 来作为例子来解释：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 1) 如果 cookie 没设置，允许缓存</div><div class="line">Header set Cache-Control &quot;public max-age=3600&quot; &quot;expr=-z resp(&apos;Set-Cookie&apos;)</div><div class="line"></div><div class="line"># 2) 如果 cookie 被设置，不允许缓存</div><div class="line">Header always remove Cache-Control &quot;expr=-n resp(&apos;Set-Cookie&apos;)</div><div class="line"></div><div class="line"># 2a) 第二条的另一种形式，如果设置了 cookie，缓存时间设置成0</div><div class="line">Header set Cache-Control &quot;no-cache max-age=0 must-revalidate&quot; &quot;expr=-n resp(&apos;Set-Cookie&apos;)</div></pre></td></tr></table></figure></p>
<ul>
<li>规则1：如果没设置 <code>Set-Cookie</code>，则给 <code>Cache-Control</code> 设置一个默认值；</li>
<li>规则2：如果设置了 <code>Set-Cookie</code>，则忽略 <code>Cache-Control</code>；</li>
<li>规则2a：是规则2的另一种表示形式，设置最大缓存时间是 0。</li>
</ul>
<h3 id="不设置-cookie-的访问路径"><a href="#不设置-cookie-的访问路径" class="headerlink" title="不设置 cookie 的访问路径"></a>不设置 cookie 的访问路径</h3><p>一些 CMS /框架还在使用一种暴力的方式种 cookie。而实际上，决定是否种 cookie 取决于不同的因素，比如会话时间因素。如果你有一个很高安全性的 web 应用，设置会话时间是 5 分钟，那么为每个响应设置一个新 cookie 都不过分。而假设你的应用连“用户特性”都没有，也就是说所有的东西对所有用户都是公用的，那么设置任何形式的 cookie 都是没有道理的。</p>
<p>所以下面这个例子是否适合你自己，很大程度上依赖于你的应用到底是什么类型的。我们来一起看一下，我先给一下这个例子的上下文关系：假设你有个新网站，你的所有文章都在 <a href="http://www.foobar.tld/news/item/" target="_blank" rel="external">http://www.foobar.tld/news/item/</a><id> 这个路径下面。现在你希望能够保证，所有访问 <code>/news/item/&lt;ID&gt;</code> 的路径都不包含 <code>Set-Cookie</code>，因为你确定不需要 cookie。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 通用 PHP 重定向做法，将&quot;?path=$1&quot;写到重定向规则里</div><div class="line">RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</div><div class="line">RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</div><div class="line">RewriteRule ^(.*)$ index.php?path=$1 [NC,L,QSA]</div><div class="line">RewriteRule ^$ index.php [NC,L,QSA]</div><div class="line"></div><div class="line"># 利用 query 中的 path= 来判断</div><div class="line">&lt;If &quot;%&#123;QUERY_STRING&#125; =~ m#path=news/item/[^&amp;]+#&quot;&gt;</div><div class="line">    Header always unset Set-Cookie</div><div class="line">&lt;/If&gt;</div></pre></td></tr></table></figure></id></p>
<p>通过这样的设置，你就可以保证所有访问 <code>/news/item/&lt;ID&gt;</code> 的路径都不包含 <code>Set-Cookie</code>。而到底是否应该设置 cookie，需要你根据你自己的应用特点来判断。</p>
<h3 id="设计出来的缓存能力"><a href="#设计出来的缓存能力" class="headerlink" title="设计出来的缓存能力"></a>设计出来的缓存能力</h3><p>有很多设计方案可以使你的 web 应用具有高缓存性。鉴于本文仅仅是一篇文章而不是一本书，我不可能每个点都深入的来讲，但是我可以着重提一下通用的方法。</p>
<p>我还用电商作为例子。假设电商网站首页的 top 位置上展示了正在出售的物品，生成这些物品需要进行若干次的数据库操作，代价比较大，因此希望把它们缓存起来。但是，问题在于购物车，它是为那些登陆用户准备的，所以希望得到的结果是： top 物品是一样的，而针对登陆用户展示购物车。</p>
<p><img src="https://huzidaha.github.io/images-store/201702/9-3.png" alt=""></p>
<p>那么优化策略首先要为每个用户提供一个和登陆状态无关的“通用”页。然后通过 JavaScript 为已经生成的网页提供购物车。站在用户的视角，最终展示形式是一样的。那么现在你有了两个请求（整个网页请求 + 购物车请求），而不是一个请求（整个网页请求，包含购物车）。ok，现在你可以把代价很大的部分，即 top 物品分离出来，把它们缓存起来了。</p>
<p><img src="https://huzidaha.github.io/images-store/201702/9-4.png" alt=""></p>
<p>这种方法或者其延伸方法，不适合已经开发好的项目。因为它可能会改变很多接口和视图层（MVC 架构）的内容。最好你在一开始就设计好。</p>
<h2 id="缓存失效：busting-和-purging"><a href="#缓存失效：busting-和-purging" class="headerlink" title="缓存失效：busting 和 purging"></a>缓存失效：busting 和 purging</h2><p>使用 <code>max-age</code> 和 <code>s-maxage</code> 你已经可以很好地控制一个指定的响应被缓存多长时间。但是这不足以适用于所有的情况。这些设置都是在返回响应时预设的，而现实情况往往是并不知道一个响应应该设置多久期满。回想一下刚才电商首页的例子：假设它包含了展示在 top 位置的 10 个实体。你设置了 <code>max-age=900</code>给这个首页以保证每15分钟刷新一次。现在，其中 1 个实体由于发布了太久了要被撤销，那么你就需要把之前的缓存响应删掉，这时候其实还没到 15 分钟，那么该怎么办？</p>
<p>不要担心，这是一个常见的问题，有很多方法解决。首先我们先来解释一下术语：</p>
<ul>
<li><strong>缓存 busting</strong>，是用来解决浏览器长期缓存问题，它通过版本标识来告诉浏览器该文件有一个新的版本。这时浏览器将不会从本地缓存取内容，而从源服务器请求新版本的文件。</li>
<li><strong>缓存 purging</strong>，表示直接从缓存中删除内容（即响应），以使得缓存可以立马得到更新。</li>
</ul>
<h3 id="用于版本管理的缓存-busting"><a href="#用于版本管理的缓存-busting" class="headerlink" title="用于版本管理的缓存 busting"></a>用于版本管理的缓存 busting</h3><p>这种方法经常使用在 CSS 文件、JS 文件上。通常一个确切的版本号、一串哈希或者时间戳都可以用作标识，如下面的例子：</p>
<ul>
<li>数字版本号：<code>style-v1.css</code>，<code>style.css?v=1</code></li>
<li>哈希串版本：<code>style.css?d3b07384d113edec49eaa6238ad5ff00</code></li>
<li>时间戳版本：<code>styles.css?t=1486398121</code></li>
</ul>
<p>这时候在发布程序的时候，你只要注意文件的版本就可以了。举个例子，一个 HTML 网页通过 <code>&lt;link rel=&quot;stylesheet&quot; href=&quot;..&quot;&gt;</code> 这种形式包含了一个 CSS 文件。CSS 文件将会被缓存起来，这时如果你想让你的新 CSS 文件起作用，那么用最新的版本号命名它就可以。如果不做任何变化的话，即便你更新了文件，这个 HTML 还会使用缓存中的旧 CSS 文件。</p>
<h3 id="缓存-purging"><a href="#缓存-purging" class="headerlink" title="缓存 purging"></a>缓存 purging</h3><p>不同 CDN 供应商清除缓存的方式不一样。很多供应商都是基于开源软件 <a href="https://varnish-cache.org/" target="_blank" rel="external">Varnish</a> 来构建自己的 CDN 服务，所以一个通用的做法是在 HTPP 请求中使用 <code>PURGE</code> 结构，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">PURGE /news/item/i-am-obsolete HTTP/1.1</div><div class="line">Host: www.foobar.tld</div></pre></td></tr></table></figure></p>
<p>使用这个请求通常需要权限认证，或者是源确认（即 IP 白名单），不过不同供应商的要求也不一样。</p>
<p>清除一个或几个缓存项比较容易，但是在某些场景下，却不是这么简单。举个例子，一个博客的场景，博客里面都有关于作者的部分，现在你要改变关于作者的一些内容，那么你需要手动清理所有包含了作者信息的页面。你确实可以一个一个手动清理，但是假设你有成千上万个网页被影响了，那问题就变得麻烦了。</p>
<p>下面介绍一个解决方案。</p>
<h3 id="代理标签"><a href="#代理标签" class="headerlink" title="代理标签"></a>代理标签</h3><p>“代理标签” 这个名字来源于 CDN 供应商 <a href="https://www.fastly.com/" target="_blank" rel="external">Fastly</a>，不同供应商给它起的名字不一样，比如还有叫它“缓存标签”的，Varnish 叫它 <a href="http://book.varnish-software.com/4.0/chapters/Cache_Invalidation.html#hashtwo-xkey-varnish-software-implementation-of-surrogate-keys" target="_blank" rel="external">Hashtwo/Xkey</a>，这里我就不详细介绍其他供应商的情况了。</p>
<p>不论它叫什么，它们的目的都是一样的：给响应打标签。这样你就可以轻松地从缓存中删除相关的标签就可以，甚至都不用知道缓存的到底是什么东西。</p>
<p>还是拿&lt;客户端-代理-源端&gt;来举例子，源端返回一个含有代理标签的响应：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Type: text/html</div><div class="line">Content-Length: 123</div><div class="line">Surrogate-Key: top-10 company-acme category-foodstuff</div></pre></td></tr></table></figure></p>
<p>这个例子中的标签为：<code>top-10</code>， <code>company-acme</code>，和 <code>category-foodstuff</code>。这里给一个电商的实际场景来理解其含义：这个响应包含了电商首页的前 10 个物品，这些物品由 ACME 公司提供，并且其目录类别都设定为食品类。</p>
<p>设置了标签以后，当物品发生了变化以后，你只需要删除包含有 <code>company-acme</code> 和 <code>top-10</code> 的标签就可以了。是不是很简单？</p>
<p>同样，具体如何清除缓存的操作方法，不同 CDN 供应商是不一样的。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>上面讨论的更多的是理论上的做法，还有很多文章专门介绍不同的 CDN 的使用。如果你想深入了解的话，下面的资料每篇可能都是你需要的。</p>
<ul>
<li><a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=en#cache-control" target="_blank" rel="external">谷歌开发者：HTTP 缓存</a></li>
<li><a href="http://www.whoishostingthis.com/blog/2010/06/30/cdns-push-vs-pull/" target="_blank" rel="external">Push CDN 和 Pull CDN</a></li>
<li><a href="http://www.the-toffee-project.org/index.php?page=32-cdn-content-delivery-networks-types" target="_blank" rel="external">CDN 类型（管理员视角）</a></li>
<li><a href="https://www.keycdn.com/support/http-caching-headers/" target="_blank" rel="external">缓存头概览</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching" target="_blank" rel="external">缓存详解（Mozilla）</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag" target="_blank" rel="external">ETag头详解（Mozilla）</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control" target="_blank" rel="external">Cace-Control 头详解（Mozilla）</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match" target="_blank" rel="external">If-None-Match 头详解（Mozilla）</a></li>
<li><a href="https://docs.fastly.com/guides/purging/getting-started-with-surrogate-keys" target="_blank" rel="external">Fastly：代理标签</a></li>
<li><a href="https://www.keycdn.com/support/purge-cdn-cache/" target="_blank" rel="external">KeyCDN：缓存标签</a></li>
</ul>

        </div>
        <footer class="article-footer">
            

    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>



        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div class="ds-thread" data-thread-key="/blog/se-http-cdn/" data-title="掌握 HTTP 缓存——从请求到响应过程的一切" data-url="http://xiaoxiaoqdq.com//blog/se-http-cdn/"></div>
    <style>
        #ds-thread #ds-reset .ds-textarea-wrapper {
            background: none;
        }
        #ds-reset .ds-avatar img {
            box-shadow: none;
        }
        #ds-reset .ds-gradient-bg {
            background: #f7f7f7;
        }
        #ds-thread #ds-reset li.ds-tab a {
            border-radius: 3px;
        }
        #ds-thread #ds-reset .ds-post-button {
            color: white;
            border: none;
            box-shadow: none;
            background: #d32;
            text-shadow: none;
            font-weight: normal;
            font-family: 'Microsoft Yahei';
        }
        #ds-thread #ds-reset .ds-post-button:hover {
            color: white;
            background: #DE594C;
        }
        #ds-thread #ds-reset .ds-post-button:active {
            background: #d32;
        }
        #ds-smilies-tooltip ul.ds-smilies-tabs li a.ds-current {
            color: white;
            background: #d32;
            box-shadow: none;
            text-shadow: none;
            font-weight: normal;
        }
    </style>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/XiaoxiaoGroup" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="http://weibo.com/u/6171082045" target="_blank">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/blog/cs-flexbox-works-2/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">通过动图形象地为你介绍 Flexbox 是如何工作的（二）</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/blog/se-http-cdn/" class="thumbnail">
    
    
        <span style="background-image:url(https://huzidaha.github.io/images-store/201702/9-1.png)" alt="掌握 HTTP 缓存——从请求到响应过程的一切" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/前端笔记/">前端笔记</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/前端笔记/Service/">Service</a></p>
                            <p class="item-title"><a href="/blog/se-http-cdn/" class="title">掌握 HTTP 缓存——从请求到响应过程的一切</a></p>
                            <p class="item-date"><time datetime="2017-03-11T15:32:00.000Z" itemprop="datePublished">2017-03-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/blog/cs-flexbox-works-2/" class="thumbnail">
    
    
        <span style="background-image:url(https://huzidaha.github.io/images-store/201702/5-1PghNPeo_XAXroKXksXGfCQ.png)" alt="通过动图形象地为你介绍 Flexbox 是如何工作的（二）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/前端笔记/">前端笔记</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/前端笔记/CSS/">CSS</a></p>
                            <p class="item-title"><a href="/blog/cs-flexbox-works-2/" class="title">通过动图形象地为你介绍 Flexbox 是如何工作的（二）</a></p>
                            <p class="item-date"><time datetime="2017-03-11T15:18:00.000Z" itemprop="datePublished">2017-03-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/blog/cs-flexbox-works-1/" class="thumbnail">
    
    
        <span style="background-image:url(https://huzidaha.github.io/images-store/201702/3-1.png)" alt="通过动图形象地为你介绍Flexbox是如何工作的（一）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/前端笔记/">前端笔记</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/前端笔记/CSS/">CSS</a></p>
                            <p class="item-title"><a href="/blog/cs-flexbox-works-1/" class="title">通过动图形象地为你介绍Flexbox是如何工作的（一）</a></p>
                            <p class="item-date"><time datetime="2017-03-11T15:02:00.000Z" itemprop="datePublished">2017-03-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/blog/js-without-loops/" class="thumbnail">
    
    
        <span style="background-image:url(https://huzidaha.github.io/images-store/201702/6-1javascript-without-loops.png)" alt="无循环 JavaScript" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/前端笔记/">前端笔记</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/前端笔记/Javascript/">Javascript</a></p>
                            <p class="item-title"><a href="/blog/js-without-loops/" class="title">无循环 JavaScript</a></p>
                            <p class="item-date"><time datetime="2017-03-11T14:52:00.000Z" itemprop="datePublished">2017-03-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/blog/ms-beginner/" class="thumbnail">
    
    
        <span style="background-image:url(http://ofi3qxlvd.bkt.clouddn.com/image/gallery/%E5%AE%8F%E6%9D%91201606-%E5%AE%89%E5%BE%BD.jpg)" alt="Web前端开发工程师编程能力飞升之路" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/面试宝典/">面试宝典</a></p>
                            <p class="item-title"><a href="/blog/ms-beginner/" class="title">Web前端开发工程师编程能力飞升之路</a></p>
                            <p class="item-date"><time datetime="2017-03-10T05:32:00.000Z" itemprop="datePublished">2017-03-10</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                <div class="widget-wrap widget-list">
    <h3 class="widget-title">微信公众号</h3>
    <div class="widget">
        <img src="/css/images/wechat.jpg" attr="wechat">
    </div>
</div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/前端笔记/">前端笔记</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/前端笔记/CSS/">CSS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端笔记/Javascript/">Javascript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端笔记/Service/">Service</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/面试宝典/">面试宝典</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud" id="tagcloud">
            <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/css/" style="font-size: 20px;">css</a> <a href="/tags/flexbox/" style="font-size: 20px;">flexbox</a> <a href="/tags/前端工程师/" style="font-size: 10px;">前端工程师</a>
        </div>
    </div>

 
            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://www.w3cfuns.com/" target="_blank">前端网</a>
                    </li>
                
                    <li>
                        <a href="http://www.yyyweb.com" target="_blank">前端里</a>
                    </li>
                
                    <li>
                        <a href="http://www.reqianduan.com" target="_blank">热前端</a>
                    </li>
                
                    <li>
                        <a href="http://www.html-js.com" target="_blank">前端乱炖</a>
                    </li>
                
                    <li>
                        <a href="http://www.webhek.com" target="_blank">WEB骇客</a>
                    </li>
                
                    <li>
                        <a href="https://segmentfault.com/" target="_blank">segmentfault</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2017 Xiaoxiao</p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'xiaoxiaoqdq'};
    (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
    || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>
<script src="/js/canvas-nest.js"></script>
<script src="/js/tagcloud.js"></script>


    <!-- Leancloud -->
    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>
        AV.initialize('lzP5SSg5UrDRDaM2mX9wUC9c-gzGzoHsz', '7ADl4tgwxomPeaxmUx3HAO1c');
    </script>
    <script>
    function showTime(Counter) {
        var query = new AV.Query(Counter);
        $('.leancloud-views_num').each(function() {
            var url = $(this).attr('id').trim();
            query.equalTo('url', url);
            query.find({
                success: function(results) {
                    if (results.length === 0) {
                        var content = '0 ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                        return;
                    }
                    for (var i = 0; i < results.length; i++) {
                        var object = results[i];
                        var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    }
                },
                error: function(object, error) {
                    console.log('Error: ' + error.code + ' ' + error.message);
                }
            });
        });
    }

    function addCount(Counter) {
      var Counter = AV.Object.extend('Counter');
      url = $('.leancloud-views_num').attr('id').trim();
      title = $('.leancloud-views_num').attr('data-flag-title').trim();
      var query = new AV.Query(Counter);
      query.equalTo('url', url);
      query.find({
          success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment('time');
                counter.save(null, {
                    success: function(counter) {
                        var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
              var newcounter = new Counter();
              newcounter.set('title', title);
              newcounter.set('url', url);
              newcounter.set('time', 1);
              newcounter.save(null, {
                  success: function(newcounter) {
                      console.log('newcounter.get(\'time\')='+newcounter.get('time'));
                      var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
                      $(document.getElementById(url)).text(content);
                  },
                  error: function(newcounter, error) {
                      console.log('Failed to create');
                  }
              });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + ' ' + error.message);
        }
      });
    }
    $(function() {
        var Counter = AV.Object.extend('Counter');
        if ($('.leancloud-views_num').length === 1) {
            addCount(Counter);
        } else if ($('.post-title-link').length > 1) {
            showTime(Counter);
        }
    });
</script>



    </div>
</body>
</html>
